# TFTP 实验图形化使用教程

本教程介绍如何在 Windows 环境下编译、启动并使用图形化监控面板 `tftp_gui.exe`，完成 TFTP 服务器的上传、下载、日志查看和异常验证等实验步骤。

## 1. 环境与准备
- 操作系统：Windows 10 或以上版本。
- 已安装 **MinGW-w64** 或其他带有 `gcc` 的编译环境，并已加入系统 `PATH`。
- 工程路径示例：`D:\计算机网络\计算机网络实验\project`。
- 确保 `tftp.exe` 客户端已启用（Windows 功能 -> 启用或关闭 Windows 功能 -> TFTP 客户端）。

## 2. 编译项目
1. 打开 PowerShell 或 CMD。
2. 进入项目根目录：
   ```powershell
   cd D:\计算机网络\计算机网络实验\project
   ```
3. 执行批处理脚本：
   ```powershell
   .\compile.bat
   ```
4. 编译成功后，目录下将生成：
   - `tftp_server.exe`：命令行版本服务器。
   - `tftp_gui.exe`：图形化监控与控制面板。

> 若编译失败，请检查编译器是否安装、`gcc` 是否在 `PATH` 中，以及是否存在中文路径导致的权限或编码问题。

## 3. 启动图形化面板
1. 双击 `tftp_gui.exe`，或在命令行执行：
   ```powershell
   .\tftp_gui.exe
   ```
2. 程序首次运行会自动创建以下目录：
   - `logs\`：服务器日志目录。
   - `tftp_root\`：服务器文件根目录。
   - `client_workspace\`：客户端缓存目录（GUI 下载文件默认保存位置）。

## 4. 界面布局速览
图形界面采用 1200×800 默认窗口，核心区域说明如下：
- **顶部状态栏**：显示服务器运行状态，并提供“启动服务器”“停止服务器”“立即刷新”按钮。
- **左侧列表**：服务器文件目录（`tftp_root`），含文件名与大小。
- **右侧列表**：客户端缓存目录（`client_workspace`），含文件名、大小、最后修改时间。
- **中部控件**：
  - 上传区：选择本地文件、指定上传后文件名、执行上传。
  - 下载区：输入服务器文件名、指定保存路径（默认在客户端目录）、执行下载。
  - “浏览”按钮可打开文件选择对话框。
- **客户端活动表**：解析服务器日志中“Client ...”条目，展示客户端地址及其最近事件。
- **底部日志与统计区**：
  - 日志窗口：实时展示 `logs\tftp_server.log` 中的最新内容。
  - 吞吐量标签：抓取最新 `Transfer statistics`，显示字节数、耗时、吞吐量。
  - 错误提示：展示最新 `[ERROR]` 日志行或管道反馈。

界面会每 2 秒自动刷新上述信息，也可手动点击“立即刷新”。

## 5. 控制服务器
1. 点击 **“启动服务器”**：
   - GUI 会在独立控制台进程内启动 `tftp_server.exe`。
   - 状态栏显示“服务器运行中”，停止按钮将被启用。
2. 点击 **“停止服务器”**：
   - 终止服务器进程，状态栏回到“服务器未启动”。
3. 若服务器异常关闭，状态栏会在下一次刷新时自动更新并允许重新启动。

## 6. 上传与下载
### 6.1 上传文件到服务器
1. 点击“浏览”选择本地待上传文件（可为任意路径）。
2. “上传后文件名”输入框默认采用所选文件名，可自行修改。
3. 点击“上传”：
   - GUI 在后台启动 `tftp -i 127.0.0.1 put` 命令。
   - 上传任务运行于独立线程，支持同时发起多个任务。
   - 完成后，最新的命令输出、退出码会显示在底部“最近错误”区域，同时刷新文件列表与日志。

### 6.2 从服务器下载到客户端
1. 在“服务器文件名”输入要下载的文件，例如 `test.txt`。
2. “保存到客户端”输入保存名称或相对路径（默认与服务器文件名相同，保存到 `client_workspace` 内）。
3. 点击“下载”：
   - GUI 发起 `tftp -i 127.0.0.1 get` 命令，后台线程运行。
   - 下载完成后，客户端文件列表与日志区域自动刷新。

> **提示**：多个上传、下载操作可并发执行，互不干扰。若需要查看命令执行详情，可在底部“最近错误”区域查看命令输出与退出码。

## 7. 查看日志、吞吐量与错误
- **日志窗口**：实时读取 `logs\tftp_server.log`，最多保留 200 KB 最新内容。若日志尚未生成，会提示“日志文件暂不可用”。
- **吞吐量**：解析最新的 `Transfer statistics` 日志行，展示传输字节数、耗时、吞吐量及重传次数（若存在）。
- **错误提示**：显示最新 `[ERROR]` 日志或上传/下载管道输出，方便定位失败原因。

## 8. 客户端访问记录
- “客户端活动”列表从日志中提取 `Client X.X.X.X:port, ...` 行，展示每个请求的来源与事件描述。
- 列表自动去重并按出现顺序列出最近 128 条记录，帮助快速回顾实验过程。

## 9. 命令行辅助操作（可选）
- 若需手动操作，可直接运行 `tftp_server.exe`，并使用系统 `tftp.exe` 命令测试上传/下载：
  ```powershell
  tftp -i 127.0.0.1 get test.txt
  tftp -i 127.0.0.1 put local.txt remote.txt
  ```
- 日志可在 `logs\tftp_server.log` 查看，上传/下载文件位于 `tftp_root\`。

## 10. 丢包重传实验（扩展）
1. 确保服务器已启动。
2. 编译并运行 `tools\lossy_rrq.exe`（若未编译可先 `gcc tools\lossy_rrq.c -o lossy_rrq.exe -lws2_32`）。
3. 客户端会故意丢弃第一个 ACK，触发服务器重传。
4. 在 GUI 底部日志与吞吐量区域可看到重传与异常处理信息。

## 11. 常见问题与排查
- **GUI 未显示文件**：确认对应目录是否存在文件并具备读写权限，可手动点击“立即刷新”。
- **上传/下载失败**：查看底部错误提示与日志文件，常见原因为服务器未启动、文件名错误、路径无权限等。
- **服务器无法启动**：确认 69 端口未被其他程序占用，必要时以管理员身份运行 GUI。
- **多线程冲突**：上传/下载线程仅通过管道与主线程通信，不会影响其他任务；若频繁操作，可适当等待命令完成后再发起下一次任务。

---

至此，图形化 TFTP 实验平台已可用于演示上传、下载、日志监控、异常重传等全部实验项目内容。祝实验顺利！
