# TFTP 服务器实验复现实验操作指南

本文档详细记录了验证实验清单七个功能点的操作步骤，按照文档执行即可复现全部测试过程。所有命令在 **Windows PowerShell**（默认编码 UTF-8）中执行，当前工程目录记为 `D:\计算机网络\计算机网络实验\project`。

---

## 0. 前置条件

- 以管理员权限打开 PowerShell（TFTP 默认使用 69 端口，需要管理员权限）。
- 已安装 Windows 自带 `tftp.exe` 客户端（Windows 10/11 默认包含）。
- 项目源码位于 `D:\计算机网络\计算机网络实验\project`，目录结构如下：
  - 源码：`src/*.c`
  - 头文件：`include/tftp.h`
  - 日志：`logs/tftp_server.log`
  - TFTP 根目录：`tftp_root/`
- 首次运行前执行一次编译：

  ```powershell
  cd "D:\计算机网络\计算机网络实验\project"
  .\compile.bat
  ```

---

## 1. 准备数据文件

```powershell
cd "D:\计算机网络\计算机网络实验\project"

# 创建上传测试用的文本文件
"Upload test content" | Out-File -FilePath sample_upload.txt -Encoding ascii

# 创建大文件（约 5 MB）验证吞吐量
fsutil file createnew large_test.bin 5000000
```

确保 `tftp_root\test.txt` 存在（程序首次启动会自动生成，也可手动检查）。

---

## 2. 功能点测试

每个测试都独立执行：启动服务器 → 等待 2 秒 → 运行客户端命令 → 等待 1–2 秒 → 关闭服务器 → 查看结果。
为简化操作，以下都使用一次性启动/停止方式。

### 2.1 正常上传文件（20 分）

```powershell
cd "D:\计算机网络\计算机网络实验\project"
$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

# 上传文件到服务器根目录，目标端文件名 uploaded_from_client.txt
tftp -i 127.0.0.1 put sample_upload.txt uploaded_from_client.txt

Start-Sleep -Seconds 1
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1
```

核对结果：

```powershell
Get-ChildItem .\tftp_root\uploaded_from_client.txt
Get-Content -Tail 5 .\logs\tftp_server.log
```

日志应包含“客户端请求上传”“文件上传完成”等记录，PowerShell 输出有 “传输成功: …”。

---

### 2.2 正常下载文件（20 分）

```powershell
cd "D:\计算机网络\计算机网络实验\project"
if (Test-Path downloaded_case2.txt) { Remove-Item downloaded_case2.txt -Force }

$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

tftp -i 127.0.0.1 get test.txt downloaded_case2.txt

Start-Sleep -Seconds 1
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1
```

验证：

```powershell
Get-ChildItem downloaded_case2.txt
Get-Content downloaded_case2.txt
Get-Content -Tail 5 .\logs\tftp_server.log
```

---

### 2.3 异常环境可靠传输（25 分）

包含两个子场景：下载缺失文件、上传已存在文件。

在继续之前，建议先编译一次用于模拟丢包的最小化客户端工具：

```powershell
cd "D:\计算机网络\计算机网络实验\project"
gcc tools\lossy_rrq.c -o tools\lossy_rrq.exe -lws2_32
```

该工具会向服务器发送 RRQ 请求，并故意丢弃第一个 ACK，以触发服务器的超时重传逻辑。

#### 2.3.1 下载不存在的文件

```powershell
cd "D:\计算机网络\计算机网络实验\project"
$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

tftp -i 127.0.0.1 get missing_file.txt missing_local.txt

Start-Sleep -Seconds 1
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1
```

结果：客户端提示“连接请求失败”，日志记录 `Cannot open file` 与 `Sent error packet: File not found`。`

#### 2.3.2 上传已存在的文件

确保 `tftp_root\uploaded_from_client.txt` 已存在（2.1 已生成）。

```powershell
cd "D:\计算机网络\计算机网络实验\project"
$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

tftp -i 127.0.0.1 put sample_upload.txt uploaded_from_client.txt

Start-Sleep -Seconds 1
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1
```

客户端提示失败，日志包含 `文件已存在` 字样及错误包。

#### 2.3.3 使用丢包客户端演示重传

```powershell
cd "D:\计算机网络\计算机网络实验\project"
$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

.\tools\lossy_rrq.exe

Start-Sleep -Seconds 1
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1

Get-Content -Tail 10 .\logs\tftp_server.log
```

期望现象：

- `lossy_rrq.exe` 输出 “Simulating packet loss: dropping ACK for block 1” 等日志。
- 服务器端日志包含 `Waiting for ACK timed out, retransmitting data packet`，并统计一次重传。
- 同时 `lossy_rrq.exe` 会在收到重传后继续发送 ACK，最终显示 “Transfer complete.”，表明服务器在丢包情况下仍能可靠完成传输。

---

### 2.4 显示上传/下载吞吐量（10 分）

使用大文件测试，观察日志中的 `Transfer statistics`。

#### 上传吞吐量

```powershell
cd "D:\计算机网络\计算机网络实验\project"
$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

tftp -i 127.0.0.1 put large_test.bin large_from_client.bin

Start-Sleep -Seconds 2
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1

Get-Content -Tail 5 .\logs\tftp_server.log
```

#### 下载吞吐量

```powershell
cd "D:\计算机网络\计算机网络实验\project"
if (Test-Path download_large.bin) { Remove-Item download_large.bin -Force }

$p = Start-Process -FilePath ".\tftp_server.exe" -PassThru
Start-Sleep -Seconds 2

tftp -i 127.0.0.1 get large_from_client.bin download_large.bin

Start-Sleep -Seconds 2
Stop-Process -Id $p.Id
Start-Sleep -Seconds 1

Get-Content -Tail 5 .\logs\tftp_server.log
```

上传/下载完成后，日志显示字节数、耗时与吞吐量，客户端提示传输速率。

---

### 2.5 传输结果显示/失败原因（10 分）

- 所有成功操作均在客户端输出“传输成功: …”；
- 异常场景（2.3）在客户端提示失败，在日志中写入具体原因（例如 “File not found”、“文件已存在”）。

验证方式：查看 PowerShell 命令行输出及 `logs\tftp_server.log`。

---

### 2.6 记录日志（10 分）

所有操作均自动在 `logs\tftp_server.log` 中记录：

- 客户端连接信息
- 上传/下载过程中的数据块、ACK、重传
- 吞吐量统计及错误原因

按测试完成后执行：

```powershell
Get-Content logs\tftp_server.log
```

可用于实验报告截图或附件。

---

### 2.7 界面友好（5 分）

服务器启动后的命令行展示帮助横幅。可单独启动服务器观察：

```powershell
cd "D:\计算机网络\计算机网络实验\project"
Start-Process -FilePath ".\tftp_server.exe"
```

界面内容包含：功能列表、配置说明、客户端命令范例、中断方法（Ctrl+C）。演示结束后到任务管理器或 `Stop-Process -Name tftp_server` 关闭即可。

---

## 3. 清理建议

- 若希望复位环境，可删除以下测试文件：

  ```powershell
  Remove-Item sample_upload.txt -Force
  Remove-Item large_test.bin -Force
  Remove-Item download_large.bin -Force
  Remove-Item downloaded_case2.txt -Force
  Remove-Item .\tftp_root\uploaded_from_client.txt -Force
  Remove-Item .\tftp_root\large_from_client.bin -Force
  ```

- 保留 `logs\tftp_server.log` 作为实验成果，不建议删除。

---

## 4. 常见问题

| 问题 | 可能原因 | 解决方案 |
| --- | --- | --- |
| 端口 69 绑定失败 | 未以管理员运行 PowerShell；端口被占用 | 以管理员权限执行；检查 `Get-Process tftp_server` 并关闭多余进程 |
| 客户端提示“连接请求失败” | 服务器尚未启动或已停止；防火墙阻拦 | 确认服务器进程存在；可临时关闭 Windows 防火墙（实验环境） |
| 下载到目标文件失败 | 目标文件只读或已有同名文件锁定 | 手动删除目标文件或更换文件名 |
| 日志中文乱码 | PowerShell 编码非 UTF-8 | 执行 `chcp 65001` 或使用英文提示 |

---

按照本文档依次操作，即可完整复现实验清单的全部功能点验证过程。祝实验顺利！
